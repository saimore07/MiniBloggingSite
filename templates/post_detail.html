{% extends "base.html" %}

{% block title %}{{ post.title }} - MiniBlog{% endblock %}

{% block content %}
<div class="container-lg py-4">
    <!-- Post Header -->
    <article class="card shadow-sm overflow-hidden">
        <div class="gradient-bg d-flex align-items-center justify-content-center" style="height: 20rem;">
            <i class="fas fa-image text-white" style="opacity:0.5;font-size:4rem;"></i>
        </div>
        
        <div class="card-body p-4 p-md-5">
            <!-- Post Meta -->
            <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle bg-secondary-subtle d-inline-flex align-items-center justify-content-center me-3" style="width:48px;height:48px;">
                    <i class="fas fa-user" style="font-size:16px;"></i>
                </div>
                <div>
                    <p class="fw-semibold text-dark mb-0">{{ post.author.username }}</p>
                    <p class="small text-secondary mb-0">{{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                </div>
            </div>
            
            <!-- Post Title -->
            <h1 class="h2 fw-bold text-dark mb-3">{{ post.title }}</h1>
            
            <!-- Post Stats -->
            <div class="d-flex align-items-center gap-4 mb-4 small text-secondary">
                <span class="d-inline-flex align-items-center"><i class="fas fa-eye me-2"></i>{{ post.view_count }} views</span>
                <span class="d-inline-flex align-items-center"><i class="fas fa-heart me-2"></i>{{ post.likes|length }} likes</span>
                <span class="d-inline-flex align-items-center"><i class="fas fa-comment me-2"></i>{{ post.comments|length }} comments</span>
                <span class="d-inline-flex align-items-center"><i class="fas fa-clock me-2"></i>{{ (post.content|length / 200)|round|int }} min read</span>
            </div>
            
            <!-- Post Content -->
            <div class="mb-4">
                {{ post.content|replace('\n', '<br>')|safe }}
            </div>
            
            <!-- Tags -->
            {% if post.tags %}
                <div class="mb-4">
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in post.tags.split(',') %}
                            <span class="badge text-bg-primary">{{ tag.strip() }}</span>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            
            <!-- Actions -->
            <div class="d-flex align-items-center justify-content-between pt-3 border-top">
                <div class="d-flex align-items-center gap-2">
                    <button id="likeBtn" onclick="toggleLike({{ post.id }})" class="btn btn-outline-danger d-inline-flex align-items-center gap-2">
                        <i class="fas fa-heart"></i>
                        <span>Like</span>
                        <span id="likeCount">{{ post.likes|length }}</span>
                    </button>
                    <button onclick="scrollToComments()" class="btn btn-outline-primary d-inline-flex align-items-center gap-2">
                        <i class="fas fa-comment"></i>
                        <span>Comment</span>
                    </button>
                    <button onclick="sharePost()" class="btn btn-outline-success d-inline-flex align-items-center gap-2">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </button>
                </div>
                {% if current_user.is_authenticated and (current_user.id == post.author_id or current_user.role == 'admin') %}
                    <div class="d-flex align-items-center gap-2">
                        <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-sm btn-outline-primary" title="Edit Post"><i class="fas fa-edit"></i></a>
                        <button onclick="deletePost({{ post.id }})" class="btn btn-sm btn-outline-danger" title="Delete Post"><i class="fas fa-trash"></i></button>
                    </div>
                {% endif %}
            </div>
        </div>
    </article>
    
    <!-- Comments Section -->
    <div id="commentsSection" class="mt-4 card shadow-sm">
        <div class="card-body">
        <h2 class="h4 fw-bold text-dark mb-3">Comments</h2>
        
        <!-- Add Comment Form -->
        {% if current_user.is_authenticated %}
            <form id="commentForm" class="mb-3">
                <div class="d-flex align-items-start gap-3">
                    <div class="rounded-circle bg-secondary-subtle d-inline-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                        <i class="fas fa-user" style="font-size:12px;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <textarea id="commentContent" name="content" rows="3" required class="form-control" placeholder="Write a comment..."></textarea>
                        <div class="d-flex align-items-center justify-content-between mt-2">
                            <p class="small text-secondary mb-0">Share your thoughts on this post</p>
                            <button type="submit" class="btn btn-gradient">Post Comment</button>
                        </div>
                    </div>
                </div>
            </form>
        {% else %}
            <div class="text-center py-8 border border-gray-200 rounded-lg mb-8">
                <p class="text-gray-600 mb-4">Please log in to leave a comment</p>
                <a href="{{ url_for('login') }}" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">
                    Sign In
                </a>
            </div>
        {% endif %}
        
        <!-- Comments List -->
        <div id="commentsList" class="d-flex flex-column gap-3">
            {% for comment in post.comments %}
                {% if comment.is_approved %}
                    <div class="border-start border-4 border-primary-subtle ps-3">
                        <div class="d-flex align-items-start gap-3">
                            <div class="rounded-circle bg-secondary-subtle d-inline-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                                <i class="fas fa-user" style="font-size:12px;"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <h4 class="h6 fw-semibold text-dark mb-0">{{ comment.author.username }}</h4>
                                    <span class="small text-secondary">{{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                                </div>
                                <p class="text-dark mb-2">{{ comment.content }}</p>
                                <div class="d-flex align-items-center gap-3">
                                    <button onclick="toggleCommentLike({{ comment.id }})" class="btn btn-sm btn-outline-danger d-inline-flex align-items-center gap-2">
                                        <i class="fas fa-heart"></i>
                                        <span>{{ comment.likes|length }}</span>
                                    </button>
                                    <button onclick="replyToComment({{ comment.id }})" class="btn btn-sm btn-outline-primary">Reply</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        {% if not post.comments %}
            <div class="text-center py-4 text-secondary">
                <i class="fas fa-comment" style="font-size:2rem;opacity:0.5;"></i>
                <p class="mb-0">No comments yet. Be the first to share your thoughts!</p>
            </div>
        {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let isLiked = false;

document.addEventListener('DOMContentLoaded', function() {
    // Check if user has liked this post
    checkLikeStatus();
    
        // Comment form submission (update comment count on success)
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const content = document.getElementById('commentContent').value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }
            
            // Show loading state
            const submitBtn = commentForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Posting...';
            submitBtn.disabled = true;
            
            // Submit comment
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Add JWT token if available
            const token = localStorage.getItem('token');
            if (token) {
                headers['Authorization'] = 'Bearer ' + token;
            }
            
            fetch('/api/comments/', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    content: content,
                    post_id: {{ post.id }}
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.comment) {
                    // Update comments list and count without full reload
                    try {
                        const commentsList = document.getElementById('commentsList');
                        const newItem = document.createElement('div');
                        newItem.className = 'border-l-4 border-blue-200 pl-6';
                        newItem.innerHTML = `
                            <div class="flex items-start space-x-4">
                                <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <h4 class="font-semibold text-gray-900">${data.comment.author}</h4>
                                        <span class="text-sm text-gray-500">just now</span>
                                    </div>
                                    <p class="text-gray-700 mb-3">${data.comment.content}</p>
                                    <div class="flex items-center space-x-4">
                                        <button class="flex items-center space-x-1 text-sm text-gray-500">
                                            <i class="fas fa-heart"></i>
                                            <span>0</span>
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                        commentsList.prepend(newItem);
                    } catch (_) {}
                    
                    // Clear textarea and restore button
                    document.getElementById('commentContent').value = '';
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                } else {
                    throw new Error(data.error || 'Failed to post comment');
                }
            })
            .catch(error => {
                alert('Failed to post comment: ' + error.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    }
});

function checkLikeStatus() {
    // This would check if the current user has liked the post
    // For now, we'll assume they haven't
    isLiked = false;
}

function toggleLike(postId) {
    const likeBtn = document.getElementById('likeBtn');
    const likeCount = document.getElementById('likeCount');
    
    const headers = {
        'Content-Type': 'application/json'
    };
    
    // Add JWT token if available
    const token = localStorage.getItem('token');
    if (token) {
        headers['Authorization'] = 'Bearer ' + token;
    }
    
    fetch(`/api/posts/${postId}/like`, {
        method: 'POST',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.liked !== undefined) {
            isLiked = data.liked;
            if (typeof data.like_count === 'number') {
                likeCount.textContent = data.like_count;
            } else {
                likeCount.textContent = data.liked ? parseInt(likeCount.textContent) + 1 : Math.max(0, parseInt(likeCount.textContent) - 1);
            }
            // Update button appearance
            if (isLiked) {
                likeBtn.classList.add('bg-red-50', 'border-red-300');
            } else {
                likeBtn.classList.remove('bg-red-50', 'border-red-300');
            }
        }
    })
    .catch(error => {
        console.error('Error toggling like:', error);
    });
}

function toggleCommentLike(commentId) {
    const headers = {
        'Content-Type': 'application/json'
    };
    
    // Add JWT token if available
    const token = localStorage.getItem('token');
    if (token) {
        headers['Authorization'] = 'Bearer ' + token;
    }
    
    fetch(`/api/comments/${commentId}/like`, {
        method: 'POST',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.liked !== undefined) {
            location.reload(); // Simple refresh for now
        }
    })
    .catch(error => {
        console.error('Error toggling comment like:', error);
    });
}

function scrollToComments() {
    document.getElementById('commentsSection').scrollIntoView({ behavior: 'smooth' });
}

function sharePost() {
    if (navigator.share) {
        navigator.share({
            title: '{{ post.title }}',
            text: 'Check out this post on MiniBlog',
            url: window.location.href
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(function() {
            alert('Post URL copied to clipboard!');
        });
    }
}

function deletePost(postId) {
    if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        fetch(`/api/posts/${postId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                window.location.href = '/dashboard';
            } else {
                alert('Failed to delete post: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Failed to delete post: ' + error.message);
        });
    }
}

function replyToComment(commentId) {
    // This would open a reply form
    alert('Reply functionality coming soon!');
}
</script>
{% endblock %}
